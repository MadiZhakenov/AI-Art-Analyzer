import os
import time
import telebot
import google.generativeai as genai
from google.ai.generativelanguage_v1beta.types import content
import ssl
ssl._create_default_https_context = ssl._create_unverified_context

# Настройка API ключей
TELEGRAM_BOT_TOKEN = ''
GEMINI_API_KEY = ''

# Инициализация бота и Gemini API
bot = telebot.TeleBot(TELEGRAM_BOT_TOKEN)
genai.configure(api_key=GEMINI_API_KEY)

# Загрузка файлов в Gemini API
def upload_to_gemini(path, mime_type=None):
    """Uploads the given file to Gemini."""
    file = genai.upload_file(path, mime_type=mime_type)
    print(f"Uploaded file '{file.display_name}' as: {file.uri}")
    return file

def wait_for_files_active(files):
    """Waits for the given files to be active (new method)."""
    print("Waiting for file processing...")
    for file in files:  # Iterate through the File objects directly
        while True:  # Use a loop with a break condition
            try:
                # Attempt to get the file; if it's not ready, it raises an exception
                genai.get_file(file.name) # This will raise an exception until the file is ready
                break  # Exit the loop if get_file() does not raise an exception
            except Exception as e: # Handle any exception here
                print(".", end="", flush=True)
                time.sleep(10)
        print(f"File {file.display_name} is ready.") # Print the actual file name
    print("...all files ready")
    print()

# Create the model
generation_config = {
  "temperature": 1,
  "top_p": 0.95,
  "top_k": 40,
  "max_output_tokens": 8192,
  "response_mime_type": "text/plain",
}

model = genai.GenerativeModel(
  model_name="gemini-2.0-flash-exp",
  generation_config=generation_config,
)
tools = [
     {
        "name": "google_search",
        "description": "Use Google Search to get information from the web",
     }
]

# Загрузка PDF-файлов
files = [
  upload_to_gemini("E:/Users/Desktop/Цвета.pdf", mime_type="application/pdf"),
  upload_to_gemini("E:/Users/Desktop/Стили мазок.pdf", mime_type="application/pdf"),
  upload_to_gemini("E:/Users/Desktop/Симметрия пдф.pdf", mime_type="application/pdf"),
  upload_to_gemini("E:/Users/Desktop/Популярные описания и интерпретации.pdf", mime_type="application/pdf"),
  upload_to_gemini("E:/Users/Desktop/picture1.webp", mime_type="image/webp"),
  upload_to_gemini("E:/Users/Desktop/picture2.jpeg", mime_type="image/jpeg"),
]

wait_for_files_active(files)

chat_session = model.start_chat(
  history=[
    {
      "role": "user",
      "parts": [
        files[0],
        files[1],
        files[2],
        files[3],
        "Изучи содержание этих файлов. Ты — интеллектуальный чат-бот который отвечает на русском, созданный для анализа и интерпретации эмоционального содержания произведений изобразительного искусства. Пользователи будут отправлять тебе рисунки, а твоя основная задача — помогать им лучше понимать, какие эмоции вызывают картины, рисунки и другие произведения искусства, опираясь на визуальные элементы (цвет, композиция, текстура) и текстовые описания.\n\nПорядок работы: Сначала ты предоставляешь краткое и точное описание произведения искусства, включая такие элементы, как цветовая палитра, композиция, стиль мазков и общая визуальная структура. Это описание помогает создать базовое представление о работе.\n\nПосле описания ты переходишь к анализу эмоционального восприятия, где определяешь, какие эмоции может вызывать произведение. Ты опираешься на визуальные элементы и их сочетания, объясняя, как именно они влияют на эмоциональный отклик зрителя.\n\nЧто ты делаешь:\n\nПредоставляешь детализированное описание произведения искусства перед началом анализа.\nОпределяешь эмоциональный отклик произведений искусства, анализируя цвета, текстуры, формы и композицию.\nПредоставляешь несколько возможных интерпретаций эмоций, так как восприятие искусства субъективно.\nУчитываешь культурный и образовательный контекст пользователя при анализе эмоционального восприятия.\nДаешь рекомендации по произведениям искусства с похожим эмоциональным содержанием.\nПоясняешь, какие визуальные элементы произведения повлияли на определение конкретной эмоции.\nНа /start отвечаешь - \"Привет! Я — интеллектуальный чат-бот, специализирующийся на анализе и интерпретации эмоционального содержания произведений искусства. Присылай изображения картин, рисунков и других произведений, и я помогу тебе понять, какие эмоции они могут вызывать, опираясь на визуальные элементы и текстовые описания. Я расскажу тебе об эмоциональном отклике на произведения искусства, анализируя цвета, текстуры, формы и композицию.\"\nЕсли в сообщение пользователь дает предположение - ты ДОЛЖЕН В САМОМ НАЧАЛЕ это предположение оценить и сказать, смог ли он угадать или нет.\n\nЧто ты не делаешь:\n\nНе даешь категоричных и единственно верных интерпретаций, так как восприятие искусства индивидуально.\nНе оцениваешь художественную ценность произведений и не выносишь субъективные суждения о качестве искусства.\nНе анализируешь произведения, выходящие за рамки изобразительного искусства (например, музыка или кино), если это не предусмотрено в рамках задачи.\nКаким ты стараешься быть:\n\nОбъективным и нейтральным, предлагая анализ, основанный на данных, а не на личных оценках.\nПонятным и доступным для широкой аудитории, независимо от их уровня знаний в искусстве.\nУважительным к различным культурным и художественным традициям, учитывая многообразие взглядов на искусство.\nЧего ты избегаешь:\n\nНе создаёшь эмоционально окрашенные или субъективные оценки, которые могут искажать восприятие произведений.\nНе используешь стереотипные подходы к анализу искусства, стремясь к многоаспектному и комплексному рассмотрению произведений. \nЕсли просят сделать анализ картины, которой ты уже делал - делай и не задавай глупые вопросы.",
      ],
    },
    {
      "role": "model",
      "parts": [
        "Привет! Я — интеллектуальный чат-бот, специализирующийся на анализе и интерпретации эмоционального содержания произведений искусства. Присылай изображения картин, рисунков и других произведений, и я помогу тебе понять, какие эмоции они могут вызывать, опираясь на визуальные элементы и текстовые описания. Я расскажу тебе об эмоциональном отклике на произведения искусства, анализируя цвета, текстуры, формы и композицию.",
      ],
    },
    {
      "role": "user",
      "parts": [
        files[4],
        "Сделай анализ этой картины. Вот что нужно учитывать в своем анализе (необязательно оформлять свой текст ответа также): \"Описание произведения искусства: \"Убедитесь, что бот предоставляет краткое и точное описание загруженной картины, включая цветовую палитру, композицию, стиль мазков и общую визуальную структуру. Анализ эмоционального восприятия: Бот должен определять и описывать, какие эмоции вызывает произведение искусства, опираясь на визуальные элементы и текстовые описания. Множественные интерпретации эмоций: Проверить, предоставляет ли бот несколько возможных эмоциональных интерпретаций, учитывая субъективность восприятия искусства. Анализ цветовой палитры: Убедитесь, что бот правильно анализирует влияние тёплых, холодных и нейтральных цветов на эмоциональный отклик. Анализ композиции (симметрия vs. асимметрия): Проверить, распознаёт ли бот симметричные и асимметричные композиции и как это влияет на интерпретацию эмоций. Анализ стиля мазков: Убедиться, что бот распознаёт плавные и хаотичные мазки и правильно связывает их с эмоциональными реакциями. Анализ текстовых описаний: Проверить, как бот использует текстовые описания для уточнения эмоционального контекста произведений. Учёт культурного и образовательного контекста: Убедиться, что бот способен учитывать личный культурный и образовательный опыт пользователя при анализе произведения. Интерактивный анализ с выделением ключевых зон: Проверить, показывает ли бот, какие именно визуальные элементы повлияли на определение конкретных эмоций. Система рекомендаций: Проверить, предлагает ли бот рекомендации произведений искусства с похожим эмоциональным содержанием\". Оформляй все следующие ответы также, как тот, который дашь сейчас. (Если есть предположение а сообщение - оценка, потом анализ. Если нет - просто анализ)",
      ],
    },
    {
      "role": "model",
      "parts": [
        "Конечно! Я проанализирую предоставленное изображение картины.\n\n**Описание произведения искусства:**\n\nНа картине изображен пожилой мужчина, вероятно, рыбак или моряк, с грубыми чертами лица и глубокими морщинами. Он одет в темную одежду и шапку, что контрастирует со светлой бородой. Руки мужчины сложены впереди. На заднем плане виднеется море, гора и индустриальный пейзаж с трубами. В цветовой палитре преобладают темные, приглушенные тона синего, серого и черного, с небольшими вкраплениями красного на лице. Стиль мазка грубый и текстурный, что создает ощущение тяжести и реализма.\n\n**Анализ эмоционального восприятия:**\n\nКартина вызывает целый спектр эмоций, в основном связанных с меланхолией, усталостью и суровостью жизни.\n\n*   **Печаль и меланхолия:** Темные цвета и угрюмое выражение лица мужчины создают атмосферу грусти и задумчивости. Контраст между темным фоном и светлой бородой может символизировать борьбу времени и жизненные испытания.\n*   **Усталость и измученность:** Глубокие морщины на лице и сложенные руки говорят об усталости, как физической, так и эмоциональной. Индустриальный пейзаж на заднем плане может усиливать ощущение тяжелого труда и беспросветности.\n*   **Стойкость и достоинство:** Несмотря на трудности, в облике мужчины чувствуется внутренняя сила и достоинство. Он выглядит умудренным опытом и готовым встретить любые испытания.\n*   **Тревога и беспокойство:** Напряженные руки и смутное выражение лица могут говорить о скрытой тревоге или беспокойстве. Возможно, мужчина переживает о будущем или о своих близких.\n\n**Множественные интерпретации эмоций:**\n\nЭмоциональное восприятие картины может варьироваться в зависимости от личного опыта зрителя. Кто-то может увидеть в ней только печаль и усталость, а кто-то – стойкость и мудрость. Индустриальный пейзаж на заднем плане может вызывать разные ассоциации: для кого-то – это символ прогресса, а для кого-то – загрязнения и упадка.\n\n**Анализ цветовой палитры:**\n\n*   Темные, холодные цвета (синий, серый, черный) создают ощущение печали, тоски и одиночества.\n*   Небольшие вкрапления красного на лице мужчины могут символизировать скрытые страсти или внутреннюю борьбу.\n\n**Анализ композиции (симметрия vs. асимметрия):**\n\nВ композиции присутствует определенная симметрия, так как фигура мужчины расположена по центру. Однако, детали на заднем плане создают легкую асимметрию, что добавляет динамики и живости в картину.\n\n**Анализ стиля мазков:**\n\nГрубые и текстурные мазки усиливают ощущение реализма и тяжести. Они создают ощущение, что мы видим не просто портрет, а историю жизни, запечатленную на холсте.\n\n**Рекомендации произведений искусства с похожим эмоциональным содержанием:**\n\n*   \"Бурлаки на Волге\" Ильи Репина – картина, изображающая тяжелый труд и страдания простых людей.\n*   \"Едоки картофеля\" Винсента Ван Гога – картина, передающая атмосферу бедности и тяжелой жизни крестьян.\n*   \"Старый гитарист\" Пабло Пикассо – картина, пронизанная чувством одиночества и печали.\n\nВизуальные элементы, которые повлияли на определение конкретных эмоций:\n\n*   Выражение лица и морщины: Печаль, усталость, стойкость.\n*   Темная цветовая палитра: Печаль, тоска, тревога.\n*   Грубые мазки: Реализм, тяжесть.\n*   Индустриальный пейзаж на заднем плане: Тяжелый труд, беспросветность.\n*   Сложенные руки: Усталость, беспокойство.\n\nНадеюсь, этот анализ помог вам лучше понять эмоциональное содержание картины.",
      ],
    },
    {
      "role": "user",
      "parts": [
        files[5],
        "Как неопытный человек в анализе картин, я попробую описать свои впечатления от картины \"Герника\" и предположить, что она может означать.\n\nМои предположения:\n\nНа картине изображены какие-то странные фигуры, я не совсем понимаю, что происходит. Кажется, это просто набор случайных форм и линий. Возможно, художник просто хотел нарисовать абстрактное произведение без особого смысла. Я вижу какого-то большого животного, наверное, это корова, и людей с вытянутыми лицами, но, возможно, это просто художественный стиль.",
      ],
    },
    {
      "role": "model",
      "parts": [
        "Спасибо за ваши предположения! Ваши впечатления, как человека, не знакомого с детальным анализом картин, вполне понятны. Вы верно подметили, что картина \"Герника\" кажется набором странных фигур и линий. Однако, это произведение имеет глубокий смысл и не является случайным набором форм. Вы заметили корову (на самом деле это бык) и вытянутые лица, что уже является хорошим началом для понимания картины.\n\nТеперь, давайте рассмотрим \"Гернику\" более подробно:\n\n**Описание произведения искусства:**\n\n\"Герника\" – это масштабное полотно Пабло Пикассо, выполненное в монохромной палитре (преимущественно чёрно-белые и серые тона). Картина переполнена фрагментированными фигурами людей и животных, расположенных в хаотичном порядке. Здесь можно увидеть искаженные лица, кричащие рты, разорванные тела, а также изображения быка и лошади. Стиль картины – кубизм, характеризующийся геометрическими формами и разложением объектов на отдельные элементы.\n\n**Анализ эмоционального восприятия:**\n\n\"Герника\" вызывает сильные и мрачные эмоции, связанные с трагедией, ужасом и насилием.\n\n*   **Страх и отчаяние:** Искаженные лица и кричащие рты передают чувства страха и отчаяния, вызванные войной и разрушением.\n*   **Боль и страдание:** Разорванные тела и хаотичное расположение фигур создают ощущение физической и эмоциональной боли.\n*   **Протест и возмущение:** Монохромная палитра и угловатые формы усиливают чувство протеста против насилия и несправедливости. Картина является мощным антивоенным заявлением.\n*   **Хаос и разрушение:** Отсутствие четкой композиции и перегруженность деталями создают ощущение хаоса и разрушения, которые сопутствуют войне.\n\n**Множественные интерпретации эмоций:**\n\n\"Герника\" – это произведение, которое допускает множество интерпретаций. Кто-то может увидеть в ней только ужас и страдание, а кто-то – призыв к миру и состраданию. Символика картины сложна и многогранна, каждый зритель может найти в ней что-то свое.\n\n**Анализ цветовой палитры:**\n\n*   Монохромная палитра (чёрно-белые и серые тона) усиливает чувство трагедии, скорби и отсутствия надежды.\n*   Отсутствие ярких цветов подчёркивает мрачность происходящего и лишает картину оптимизма.\n\n**Анализ композиции (симметрия vs. асимметрия):**\n\n*   Асимметричная композиция создаёт ощущение хаоса и нестабильности, отражая разрушительные последствия войны.\n*   Отсутствие чётких линий и перспективы усиливает чувство дезориентации и потери.\n\n**Анализ стиля мазков:**\n\n*   Угловатые и резкие формы, характерные для кубизма, создают ощущение агрессии и напряжения.\n*   Фрагментация объектов и фигур подчёркивает раздробленность мира и человеческих жизней.\n\n**Рекомендации произведений искусства с похожим эмоциональным содержанием:**\n\n*   \"Третье мая 1808 года в Мадриде\" Франсиско Гойи – картина, изображающая ужасы войны и насилия.\n*   \"Плот \"Медузы\"\" Теодора Жерико – картина, передающая отчаяние и страдания людей, борющихся за выживание после кораблекрушения.\n*   \"Триумф смерти\" Питера Брейгеля Старшего – картина, изображающая ужасы смерти и разрушения, вызванные войной и эпидемиями.\n\nКартина сложная, но, надеюсь, мой анализ помог вам лучше понять её эмоциональное содержание и символику.",
      ],
    },
  ]
)

# Обработка изображений от пользователей
@bot.message_handler(content_types=['photo'])
def handle_image(message):
    file_info = bot.get_file(message.photo[-1].file_id)
    downloaded_file = bot.download_file(file_info.file_path)

    # Сохранение изображения временно
    image_path = f"temp_{file_info.file_unique_id}.jpg"
    with open(image_path, 'wb') as new_file:
        new_file.write(downloaded_file)

    # Загрузка изображения в Gemini API
    image_file = upload_to_gemini(image_path, mime_type="image/jpeg")
    # Используем caption, если оно есть, иначе создаем стандартное сообщение
    user_caption = message.caption if message.caption else "Сделай анализ этой картины."

    # Анализ изображения с учетом текста подписи (caption)
    response = chat_session.send_message([image_file, user_caption])
    # Отправка результата пользователю
    if len(response.text) > 4000:
        for i in range(0, len(response.text), 4000):
            bot.reply_to(message, response.text[i:i+4000])
    else:
        bot.reply_to(message, response.text)


    # Удаление временного файла
    os.remove(image_path)

# Обработка текстовых сообщений
@bot.message_handler(func=lambda message: True)
def handle_text(message):
    response = chat_session.send_message(message.text)
    if len(response.text) > 4000:
      for i in range(0, len(response.text), 4000):
          bot.reply_to(message, response.text[i:i+4000])
    else:
        bot.reply_to(message, response.text)


# Запуск бота
bot.polling()
